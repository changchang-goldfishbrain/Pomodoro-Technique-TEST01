<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#FFFFFF">
    <meta name="description" content="DuoFocus Pomodoro Timer">
    <title>DuoFocus Timer</title>
    
    <!-- PWA 相關圖示連結 (若您有準備圖片，請放在同層目錄) -->
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="pwa-192x192.png">

    <!-- Tailwind CSS (樣式) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        unfinished: '#4F9D9D', // Teal (設定的時間/未完成)
                        finished: '#FFFFFF',   // White (已完成/背景)
                    },
                    fontFamily: {
                        sans: ['system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    screens: {
                        'landscape': {'raw': '(orientation: landscape)'},
                    }
                }
            }
        }
    </script>

    <!-- React & Babel (核心邏輯) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Generative AI SDK -->
    <script type="importmap">
{
  "imports": {
    "@google/generative-ai": "https://esm.run/@google/generative-ai",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "@vitejs/plugin-react": "https://aistudiocdn.com/@vitejs/plugin-react@^5.1.1",
    "vite": "https://aistudiocdn.com/vite@^7.2.4",
    "vite-plugin-pwa": "https://aistudiocdn.com/vite-plugin-pwa@^1.2.0"
  }
}
</script>

    <style>
        /* 禁止選取與彈性滾動，讓網頁更像 APP */
        body {
            margin: 0;
            overflow: hidden;
            background-color: #FFFFFF;
            color: #4F9D9D;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }
        /* 隱藏捲軸 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 動畫 */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // --- ICONS ---
        const Icons = {
            Play: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}>
                    <path fillRule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653Z" clipRule="evenodd" />
                </svg>
            ),
            Pause: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}>
                    <path fillRule="evenodd" d="M6.75 5.25a.75.75 0 0 1 .75-.75H9a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75H7.5a.75.75 0 0 1-.75-.75V5.25Zm7.5 0A.75.75 0 0 1 15 4.5h1.5a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75H15a.75.75 0 0 1-.75-.75V5.25Z" clipRule="evenodd" />
                </svg>
            ),
            Reset: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className={className}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
            ),
            Settings: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className={className}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" />
                    <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                </svg>
            ),
            Sparkles: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className={className}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z" />
                </svg>
            ),
            Close: ({ className }) => (
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className={className}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M6 18 18 6M6 6l12 12" />
                </svg>
            )
        };

        // --- COMPONENT: AnalogClock ---
        // 核心邏輯：雙層渲染 + Mask 遮罩，確保顏色對比
        const AnalogClock = ({ remainingSeconds, className }) => {
            const minutes = remainingSeconds / 60;
            const angle = Math.min(359.9, minutes * 6);
            
            const r = 48;
            const cx = 50;
            const cy = 50;
            
            const endAngleRad = (angle - 90) * (Math.PI / 180);
            const endX = cx + r * Math.cos(endAngleRad);
            const endY = cy + r * Math.sin(endAngleRad);
            
            const largeArcFlag = angle > 180 ? 1 : 0;
            
            const wedgePath = minutes >= 60 
                ? `M 50 2 A 48 48 0 1 1 49.99 2 Z`
                : `M ${cx} ${cy} L 50 ${50 - r} A ${r} ${r} 0 ${largeArcFlag} 1 ${endX} ${endY} Z`;

            const renderFaceContent = (color) => (
                <g fill={color} stroke={color}>
                    {/* 刻度 */}
                    {Array.from({ length: 60 }).map((_, i) => {
                        const isHour = i % 5 === 0;
                        const length = isHour ? 3 : 1;
                        const width = isHour ? 0.8 : 0.4;
                        return (
                            <line key={`tick-${i}`} x1="50" y1="4" x2="50" y2={4 + length} 
                                stroke={color} strokeWidth={width} transform={`rotate(${i * 6} 50 50)`} />
                        );
                    })}
                    {/* 數字 */}
                    {Array.from({ length: 12 }).map((_, i) => {
                        const n = i + 1;
                        const val = n * 5;
                        const a = n * 30;
                        const rad = (a - 90) * (Math.PI / 180);
                        const dist = 38;
                        const nx = 50 + dist * Math.cos(rad);
                        const ny = 50 + dist * Math.sin(rad);
                        return (
                            <text key={`num-${n}`} x={nx} y={ny} 
                                textAnchor="middle" dominantBaseline="middle"
                                fontSize="3.5" fontWeight="700" fill={color} stroke="none" 
                                className="font-sans select-none" style={{userSelect: 'none'}}>
                                {val}
                            </text>
                        );
                    })}
                </g>
            );

            return (
                <svg viewBox="0 0 100 100" className={className}>
                    <defs>
                        <mask id="wedgeMask">
                            <rect x="0" y="0" width="100" height="100" fill="black" />
                            <path d={wedgePath} fill="white" />
                        </mask>
                    </defs>
                    {/* Layer 1: 底盤 (白) */}
                    <circle cx="50" cy="50" r="49" fill="currentColor" className="text-finished" />
                    {/* Layer 2: 基礎刻度 (Teal) */}
                    <g className="text-unfinished">{renderFaceContent('currentColor')}</g>
                    {/* Layer 3: 扇形計時 (Teal) */}
                    <path d={wedgePath} fill="currentColor" className="text-unfinished transition-[d] duration-300 ease-linear" />
                    {/* Layer 4: 覆蓋刻度 (白) - 使用 Mask 僅顯示在扇形上 */}
                    <g className="text-finished" mask="url(#wedgeMask)">{renderFaceContent('currentColor')}</g>
                    {/* Layer 5: 中心點 */}
                    <circle cx="50" cy="50" r="3.5" fill="currentColor" className="text-unfinished" />
                </svg>
            );
        };

        // --- SERVICE: Gemini AI ---
        const getFocusTip = async (durationMinutes, apiKey) => {
            if (!apiKey) return "請先在設定中輸入 API Key";
            try {
                const genAI = new GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                
                const prompt = `Give me a single, short, impactful sentence of advice for staying focused during a ${durationMinutes}-minute deep work session. Do not use quotes. Just the advice.`;
                
                const result = await model.generateContent(prompt);
                const response = await result.response;
                return response.text().trim();
            } catch (error) {
                console.error("AI Error:", error);
                return "專注當下，一步一腳印。";
            }
        };

        // --- MAIN APP ---
        const App = () => {
            // State
            const [timeSettings, setTimeSettings] = React.useState({ minutes: 25, seconds: 0 });
            const [totalSeconds, setTotalSeconds] = React.useState(25 * 60);
            const [remainingSeconds, setRemainingSeconds] = React.useState(25 * 60);
            const [status, setStatus] = React.useState('IDLE'); // IDLE, RUNNING, PAUSED, COMPLETED
            const [showSettings, setShowSettings] = React.useState(false);
            const [apiKey, setApiKey] = React.useState('');
            const [focusTip, setFocusTip] = React.useState(null);
            const [loadingTip, setLoadingTip] = React.useState(false);

            const endTimeRef = React.useRef(null);
            const rafRef = React.useRef(null);

            // 讀取 LocalStorage (保存設定與 API Key)
            React.useEffect(() => {
                const savedKey = localStorage.getItem('GEMINI_API_KEY');
                if (savedKey) setApiKey(savedKey);
                
                const savedTime = localStorage.getItem('TIMER_SETTINGS');
                if (savedTime) {
                    const parsed = JSON.parse(savedTime);
                    setTimeSettings(parsed);
                    setTotalSeconds(parsed.minutes * 60 + parsed.seconds);
                    setRemainingSeconds(parsed.minutes * 60 + parsed.seconds);
                }
            }, []);

            // 音效
            const playBeep = () => {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'sine';
                osc.frequency.value = 880;
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.5);
                osc.start();
                osc.stop(ctx.currentTime + 0.5);
            };

            // 計時器邏輯
            const tick = () => {
                if (!endTimeRef.current) return;
                const now = Date.now();
                const left = Math.ceil((endTimeRef.current - now) / 1000);
                
                if (left <= 0) {
                    setRemainingSeconds(0);
                    setStatus('COMPLETED');
                    playBeep();
                } else {
                    setRemainingSeconds(left);
                    rafRef.current = requestAnimationFrame(tick);
                }
            };

            const startTimer = () => {
                setStatus('RUNNING');
                const now = Date.now();
                endTimeRef.current = now + remainingSeconds * 1000;
                rafRef.current = requestAnimationFrame(tick);
            };

            const pauseTimer = () => {
                setStatus('PAUSED');
                if (rafRef.current) cancelAnimationFrame(rafRef.current);
                endTimeRef.current = null;
            };

            const resetTimer = () => {
                setStatus('IDLE');
                if (rafRef.current) cancelAnimationFrame(rafRef.current);
                endTimeRef.current = null;
                setRemainingSeconds(totalSeconds);
            };

            // 設定變更
            const handleTimeChange = (e, field) => {
                let val = parseInt(e.target.value) || 0;
                if (field === 'seconds' && val > 59) val = 59;
                if (val < 0) val = 0;
                
                const newSettings = { ...timeSettings, [field]: val };
                setTimeSettings(newSettings);
                
                // 儲存並重置
                const newTotal = newSettings.minutes * 60 + newSettings.seconds;
                setTotalSeconds(newTotal);
                setRemainingSeconds(newTotal);
                setStatus('IDLE');
                localStorage.setItem('TIMER_SETTINGS', JSON.stringify(newSettings));
            };

            const handleApiKeyChange = (e) => {
                setApiKey(e.target.value);
                localStorage.setItem('GEMINI_API_KEY', e.target.value);
            };

            // AI 請求
            const handleFetchTip = async () => {
                setLoadingTip(true);
                const tip = await getFocusTip(timeSettings.minutes, apiKey);
                setFocusTip(tip);
                setLoadingTip(false);
            };

            return (
                <div className="relative w-full h-screen overflow-hidden font-sans bg-finished text-unfinished flex flex-col landscape:flex-row items-center justify-center p-6 gap-8 landscape:gap-16">
                    
                    {/* 左側：時鐘 (Landscape 在左，Portrait 在上) */}
                    <div className="relative flex-shrink-0 w-[85vw] h-[85vw] max-w-[400px] max-h-[400px] landscape:w-[80vh] landscape:h-[80vh] landscape:max-w-none landscape:max-h-none aspect-square bg-finished border-4 border-unfinished rounded-[22%] shadow-2xl p-6 sm:p-8 flex items-center justify-center">
                        {/* 頂部裝飾 */}
                        <div className="absolute -top-3 left-1/2 -translate-x-1/2 w-[30%] h-3 bg-unfinished rounded-t-lg opacity-50"></div>
                        
                        <div className="w-full h-full relative">
                            <AnalogClock remainingSeconds={remainingSeconds} className="w-full h-full" />
                            {status === 'COMPLETED' && (
                                <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                    <span className="bg-unfinished text-finished px-6 py-2 rounded-full text-xl font-bold uppercase tracking-widest animate-pulse shadow-md">
                                        Time's Up
                                    </span>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* 右側：控制區 */}
                    <div className="flex flex-col items-center gap-6 landscape:items-start w-full max-w-xs landscape:max-w-none">
                        
                        {/* 按鈕群 */}
                        <div className="flex items-center gap-6">
                            {status === 'IDLE' && (
                                <button onClick={() => setShowSettings(true)} className="p-4 rounded-full border-2 border-unfinished hover:bg-unfinished hover:text-finished transition-colors">
                                    <Icons.Settings className="w-6 h-6" />
                                </button>
                            )}

                            {status === 'RUNNING' ? (
                                <button onClick={pauseTimer} className="p-6 rounded-full bg-unfinished text-finished hover:opacity-90 shadow-lg transform active:scale-95 transition-transform">
                                    <Icons.Pause className="w-8 h-8" />
                                </button>
                            ) : (
                                <button onClick={startTimer} disabled={status === 'COMPLETED'} className="p-6 rounded-full bg-unfinished text-finished hover:opacity-90 shadow-lg disabled:opacity-50 transform active:scale-95 transition-transform">
                                    <Icons.Play className="w-8 h-8 translate-x-0.5" />
                                </button>
                            )}

                            <button onClick={resetTimer} className="p-4 rounded-full border-2 border-unfinished hover:bg-unfinished hover:text-finished transition-colors">
                                <Icons.Reset className="w-6 h-6" />
                            </button>
                        </div>

                        {/* AI 提示區 */}
                        <div className="h-16 flex items-center justify-center landscape:justify-start w-full px-4 text-center landscape:text-left">
                            {focusTip ? (
                                <p className="text-sm font-bold animate-fade-in">{focusTip}</p>
                            ) : (
                                <button onClick={handleFetchTip} disabled={loadingTip} className="flex items-center gap-2 text-xs font-bold uppercase tracking-widest opacity-60 hover:opacity-100 transition-opacity">
                                    <Icons.Sparkles className={`w-4 h-4 ${loadingTip ? 'animate-spin' : ''}`} />
                                    {loadingTip ? 'Thinking...' : 'Inspire Me'}
                                </button>
                            )}
                        </div>
                    </div>

                    {/* 設定視窗 Modal */}
                    {showSettings && (
                        <div className="absolute inset-0 z-50 flex items-center justify-center bg-finished/95 backdrop-blur-sm p-4">
                            <div className="w-full max-w-sm flex flex-col items-center animate-fade-in">
                                <button onClick={() => setShowSettings(false)} className="self-end mb-4 text-unfinished hover:opacity-70">
                                    <Icons.Close className="w-8 h-8" />
                                </button>
                                
                                <h2 className="text-2xl font-bold mb-8 uppercase tracking-widest">Setup</h2>
                                
                                {/* 時間設定 */}
                                <div className="flex items-center gap-4 mb-10 font-mono">
                                    <div className="flex flex-col items-center">
                                        <input type="number" value={timeSettings.minutes} onChange={(e) => handleTimeChange(e, 'minutes')}
                                            className="w-24 h-24 text-5xl text-center bg-transparent border-b-2 border-unfinished text-unfinished focus:outline-none rounded-t-lg focus:bg-unfinished/5" />
                                        <span className="text-xs mt-2 font-bold uppercase">MIN</span>
                                    </div>
                                    <span className="text-4xl pb-8">:</span>
                                    <div className="flex flex-col items-center">
                                        <input type="number" value={timeSettings.seconds} onChange={(e) => handleTimeChange(e, 'seconds')}
                                            className="w-24 h-24 text-5xl text-center bg-transparent border-b-2 border-unfinished text-unfinished focus:outline-none rounded-t-lg focus:bg-unfinished/5" />
                                        <span className="text-xs mt-2 font-bold uppercase">SEC</span>
                                    </div>
                                </div>

                                {/* API Key 輸入 */}
                                <div className="w-full mb-8">
                                    <label className="text-xs font-bold uppercase mb-2 block opacity-70">Gemini API Key</label>
                                    <input type="password" value={apiKey} onChange={handleApiKeyChange} placeholder="Paste key here for AI features"
                                        className="w-full p-3 bg-transparent border border-unfinished rounded-lg text-unfinished placeholder-unfinished/30 focus:outline-none focus:ring-1 focus:ring-unfinished" />
                                </div>

                                <button onClick={() => setShowSettings(false)} className="w-full py-4 bg-unfinished text-finished font-bold uppercase tracking-widest rounded-xl hover:opacity-90 shadow-lg">
                                    Ready
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
